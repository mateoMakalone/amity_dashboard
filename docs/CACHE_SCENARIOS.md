# Сценарии работы с кэшем метрик

## Обзор

Система кэширования метрик в Amity Dashboard обеспечивает надежное сохранение и загрузку данных метрик между перезапусками приложения. Кэш содержит текущие значения метрик и их историю.

## Структура кэша

```json
{
  "metrics": {
    "metric_name": 42.0,
    "another_metric": 100.0
  },
  "history": {
    "metric_name": [
      [timestamp, value],
      [timestamp, value]
    ]
  },
  "last_updated": 1234567890.123,
  "cache_version": "1.0"
}
```

## Сценарии и их обработка

### 1. Отсутствующий файл кэша

**Ситуация**: Файл кэша не существует при первом запуске приложения.

**Обработка**:
- Выводится сообщение: `[DEBUG] Cache file {path} does not exist, starting with empty cache`
- Приложение запускается с пустым кэшем
- Данные начинают накапливаться с нуля

**Результат**: ✅ Приложение работает нормально, кэш создается автоматически при первом сохранении.

### 2. Пустой файл кэша

**Ситуация**: Файл кэша существует, но содержит 0 байт.

**Обработка**:
- Проверяется размер файла
- Если размер = 0, выводится: `[DEBUG] Cache file {path} is empty, starting with empty cache`
- Приложение запускается с пустым кэшем

**Результат**: ✅ Приложение работает нормально, поврежденный файл игнорируется.

### 3. Поврежденный JSON в кэше

**Ситуация**: Файл кэша содержит некорректный JSON.

**Обработка**:
- Выводится: `[WARNING] Invalid JSON in cache file {path}: {error}`
- Создается резервная копия: `{path}.corrupted.{timestamp}`
- Приложение запускается с пустым кэшем

**Результат**: ✅ Поврежденный файл сохраняется для анализа, приложение работает нормально.

### 4. Некорректная структура данных

**Ситуация**: JSON корректен, но структура данных не соответствует ожидаемой.

**Обработка**:
- Выводится: `[WARNING] Cache file {path} contains invalid data structure, starting with empty cache`
- Приложение запускается с пустым кэшем

**Результат**: ✅ Некорректные данные игнорируются, приложение работает нормально.

### 5. Проблемы с правами доступа при чтении

**Ситуация**: Файл кэша недоступен для чтения.

**Обработка**:
- Выводится: `[WARNING] Permission error reading cache file {path}: {error}`
- Приложение запускается с пустым кэшем

**Результат**: ✅ Приложение работает нормально, кэш создается в доступном месте.

### 6. Проблемы с правами доступа при записи

**Ситуация**: Нет прав на запись в директорию кэша.

**Обработка**:
- Выводится: `[WARNING] Permission error saving cache to {path}: {error}`
- Пытается сохранить в альтернативном месте: `./metrics_cache.json`
- Выводится: `[INFO] Cache saved to alternative location: {alt_path}`

**Результат**: ✅ Кэш сохраняется в альтернативном месте, приложение работает нормально.

### 7. Проблемы с директорией кэша

**Ситуация**: Директория для кэша не существует или недоступна.

**Обработка**:
- Автоматически создается директория: `[DEBUG] Created cache directory: {path}`
- Проверяется доступность для записи
- При проблемах используется альтернативная директория

**Результат**: ✅ Директория создается автоматически или используется альтернативная.

### 8. Атомарная запись кэша

**Ситуация**: Запись кэша во время работы приложения.

**Обработка**:
- Создается временный файл: `{path}.tmp`
- Данные записываются во временный файл
- Атомарно перемещается в целевой файл: `os.replace(temp_file, target_file)`

**Результат**: ✅ Исключается повреждение кэша при сбоях во время записи.

### 9. Очистка старых файлов

**Ситуация**: Наличие старых поврежденных файлов кэша.

**Обработка**:
- Автоматически удаляются файлы старше 24 часов с паттерном `.corrupted.*`
- Выводится: `[DEBUG] Removed old corrupted cache file: {filename}`

**Результат**: ✅ Диск не засоряется старыми файлами.

### 10. Валидация данных кэша

**Ситуация**: Проверка корректности загруженных данных.

**Проверки**:
- Структура данных является словарем
- Присутствуют обязательные поля: `metrics`, `history`
- `metrics` является словарем
- `history` является словарем
- Каждый элемент истории имеет формат `[timestamp, value]`

**Результат**: ✅ Только корректные данные загружаются в память.

## Конфигурация кэша

### Путь к кэшу

- **Windows**: `./metrics_cache.json` (в рабочей директории)
- **Unix/Linux**: `/tmp/metrics_cache.json`

### Интервал сохранения

- **SAVE_INTERVAL**: 60 секунд
- Кэш сохраняется после каждого обновления метрик

### Размер истории

- **HISTORY_POINTS**: Зависит от `UPDATE_INTERVAL`
- Обычно: 3600 секунд / интервал обновления

## Мониторинг кэша

### Логи

Система выводит подробные логи о работе кэша:

```
[DEBUG] Cache loaded from {path}: {metrics_count} metrics, {history_count} history entries
[DEBUG] Cache saved to {path}: {metrics_count} metrics, {history_count} history entries
[WARNING] Permission error saving cache to {path}: {error}
[INFO] Cache saved to alternative location: {alt_path}
```

### Статистика

При каждом сохранении выводится количество метрик и записей истории.

## Рекомендации

### Для разработки

1. **Тестирование**: Используйте `test_cache_scenarios.py` для проверки всех сценариев
2. **Отладка**: Включите debug-логи для мониторинга работы кэша
3. **Валидация**: Проверяйте структуру кэша при изменениях

### Для продакшена

1. **Мониторинг**: Следите за логами кэша
2. **Резервное копирование**: Регулярно проверяйте целостность кэша
3. **Очистка**: Настройте автоматическую очистку старых файлов
4. **Права доступа**: Убедитесь в корректных правах на директорию кэша

### Для отладки

1. **Проверка файла**: `ls -la /tmp/metrics_cache.json`
2. **Просмотр содержимого**: `cat /tmp/metrics_cache.json`
3. **Валидация JSON**: `python -m json.tool /tmp/metrics_cache.json`

## Обработка ошибок

Все ошибки кэша обрабатываются gracefully:

- ❌ **Критические ошибки**: Приложение продолжает работать без кэша
- ⚠️ **Предупреждения**: Выводятся в лог, но не останавливают работу
- ℹ️ **Информация**: Статус операций кэша

## Заключение

Система кэширования обеспечивает надежную работу приложения в любых условиях:

- ✅ **Отказоустойчивость**: Приложение работает даже при полном отсутствии кэша
- ✅ **Восстановление**: Автоматическое восстановление после сбоев
- ✅ **Мониторинг**: Подробные логи для диагностики
- ✅ **Безопасность**: Атомарные операции записи исключают повреждение данных 